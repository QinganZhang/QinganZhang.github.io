<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>LLMæ—¶ä»£çš„transformeré‡åŒ–åˆ†æ å‚æ•°é‡ã€è®¡ç®—é‡ã€æ¿€æ´»å€¼ | Paul's Blog</title>
<meta name=keywords content="deep learning,transformer"><meta name=description content="å®šæ€§åˆ†æ GPUä¸Šéƒ½å­˜äº†å“ªäº›ä¸œè¥¿ é¦–å…ˆæˆ‘ä»¬æ¥ä»å…¨å±€æ•´ä½“çš„è§’åº¦çœ‹ä¸€çœ‹ï¼Œåœ¨è®­ç»ƒé˜¶æ®µGPUæ˜¾å­˜ä¸Šéƒ½æœ‰å“ªäº›å†…å®¹ï¼š Model Statesï¼šæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­å¿…é¡»å­˜å‚¨çš„"><meta name=author content="Paul"><link rel=canonical href=https://qinganzhang.github.io/posts/llm%E6%97%B6%E4%BB%A3%E7%9A%84transformer%E9%87%8F%E5%8C%96%E5%88%86%E6%9E%90-%E5%8F%82%E6%95%B0%E9%87%8F%E8%AE%A1%E7%AE%97%E9%87%8F%E6%BF%80%E6%B4%BB%E5%80%BC/><link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://qinganzhang.github.io/favicon.ico><link rel=apple-touch-icon href=https://qinganzhang.github.io/apple-touch-icon.png><meta name=twitter:title content="LLMæ—¶ä»£çš„transformeré‡åŒ–åˆ†æ å‚æ•°é‡ã€è®¡ç®—é‡ã€æ¿€æ´»å€¼ | Paul's Blog"><meta name=twitter:description content="å®šæ€§åˆ†æ GPUä¸Šéƒ½å­˜äº†å“ªäº›ä¸œè¥¿ é¦–å…ˆæˆ‘ä»¬æ¥ä»å…¨å±€æ•´ä½“çš„è§’åº¦çœ‹ä¸€çœ‹ï¼Œåœ¨è®­ç»ƒé˜¶æ®µGPUæ˜¾å­˜ä¸Šéƒ½æœ‰å“ªäº›å†…å®¹ï¼š Model Statesï¼šæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­å¿…é¡»å­˜å‚¨çš„"><meta property="og:title" content="LLMæ—¶ä»£çš„transformeré‡åŒ–åˆ†æ å‚æ•°é‡ã€è®¡ç®—é‡ã€æ¿€æ´»å€¼ | Paul's Blog"><meta property="og:description" content="å®šæ€§åˆ†æ GPUä¸Šéƒ½å­˜äº†å“ªäº›ä¸œè¥¿ é¦–å…ˆæˆ‘ä»¬æ¥ä»å…¨å±€æ•´ä½“çš„è§’åº¦çœ‹ä¸€çœ‹ï¼Œåœ¨è®­ç»ƒé˜¶æ®µGPUæ˜¾å­˜ä¸Šéƒ½æœ‰å“ªäº›å†…å®¹ï¼š Model Statesï¼šæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­å¿…é¡»å­˜å‚¨çš„"><meta property="og:type" content="article"><meta property="og:url" content="https://qinganzhang.github.io/posts/llm%E6%97%B6%E4%BB%A3%E7%9A%84transformer%E9%87%8F%E5%8C%96%E5%88%86%E6%9E%90-%E5%8F%82%E6%95%B0%E9%87%8F%E8%AE%A1%E7%AE%97%E9%87%8F%E6%BF%80%E6%B4%BB%E5%80%BC/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-07T14:43:19+08:00"><meta property="article:modified_time" content="2024-09-07T14:43:19+08:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Post","item":"https://qinganzhang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"LLMæ—¶ä»£çš„transformeré‡åŒ–åˆ†æ å‚æ•°é‡ã€è®¡ç®—é‡ã€æ¿€æ´»å€¼","item":"https://qinganzhang.github.io/posts/llm%E6%97%B6%E4%BB%A3%E7%9A%84transformer%E9%87%8F%E5%8C%96%E5%88%86%E6%9E%90-%E5%8F%82%E6%95%B0%E9%87%8F%E8%AE%A1%E7%AE%97%E9%87%8F%E6%BF%80%E6%B4%BB%E5%80%BC/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"LLMæ—¶ä»£çš„transformeré‡åŒ–åˆ†æ å‚æ•°é‡ã€è®¡ç®—é‡ã€æ¿€æ´»å€¼ | Paul's Blog","name":"LLMæ—¶ä»£çš„transformeré‡åŒ–åˆ†æ å‚æ•°é‡ã€è®¡ç®—é‡ã€æ¿€æ´»å€¼","description":"å®šæ€§åˆ†æ GPUä¸Šéƒ½å­˜äº†å“ªäº›ä¸œè¥¿ é¦–å…ˆæˆ‘ä»¬æ¥ä»å…¨å±€æ•´ä½“çš„è§’åº¦çœ‹ä¸€çœ‹ï¼Œåœ¨è®­ç»ƒé˜¶æ®µGPUæ˜¾å­˜ä¸Šéƒ½æœ‰å“ªäº›å†…å®¹ï¼š Model Statesï¼šæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­å¿…é¡»å­˜å‚¨çš„","keywords":["deep learning","transformer"],"wordCount":"3840","inLanguage":"en","datePublished":"2024-09-07T14:43:19+08:00","dateModified":"2024-09-07T14:43:19+08:00","author":{"@type":"Person","name":"Paul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://qinganzhang.github.io/posts/llm%E6%97%B6%E4%BB%A3%E7%9A%84transformer%E9%87%8F%E5%8C%96%E5%88%86%E6%9E%90-%E5%8F%82%E6%95%B0%E9%87%8F%E8%AE%A1%E7%AE%97%E9%87%8F%E6%BF%80%E6%B4%BB%E5%80%BC/"},"publisher":{"@type":"Organization","name":"Paul's Blog","logo":{"@type":"ImageObject","url":"https://qinganzhang.github.io/favicon.ico"}}}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.css integrity=sha384-bYdxxUwYipFNohQlHt0bjN/LCpueqWz13HufFEV1SUatKs1cm4L6fFgCi1jT643X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.js integrity=sha384-Qsn9KnoKISj6dI8g7p1HBlNpVx0I8p1SvlwOldgi3IorMle61nQy4zEahWYtljaz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="auto",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://qinganzhang.github.io/ accesskey=h title="Paul's Blog (Alt + H)">Paul's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://qinganzhang.github.io/posts/ title=Posts class=active>Posts</a></li><li><a href=https://qinganzhang.github.io/archives/ title=Archive>Archive</a></li><li><a href=https://qinganzhang.github.io/search/ title="Search (Alt + /)" data-no-instant accesskey=/>Search</a></li><li><a href=https://qinganzhang.github.io/tags/ title=Tags>Tags</a></li><li><a href=https://qinganzhang.github.io/categories/ title=Categories>Categories</a></li><li><a href=https://qinganzhang.github.io/about/ title=About>About</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://qinganzhang.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://qinganzhang.github.io/posts/>Post</a></div><h1 class=post-title>LLMæ—¶ä»£çš„transformeré‡åŒ–åˆ†æ å‚æ•°é‡ã€è®¡ç®—é‡ã€æ¿€æ´»å€¼</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg>
<span>2024-09-07</span></span><span class=meta-item>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://qinganzhang.github.io/tags/deep-learning/>deep learning</a><a href=https://qinganzhang.github.io/tags/transformer/>transformer</a></span></span><span class=meta-item>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg>
<span>3840 words</span></span><span class=meta-item>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>8 min</span></span></div></header><div class="toc side right"><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%ae%9a%e6%80%a7%e5%88%86%e6%9e%90 aria-label=å®šæ€§åˆ†æ>å®šæ€§åˆ†æ</a><ul><li><a href=#gpu%e4%b8%8a%e9%83%bd%e5%ad%98%e4%ba%86%e5%93%aa%e4%ba%9b%e4%b8%9c%e8%a5%bf aria-label=GPUä¸Šéƒ½å­˜äº†å“ªäº›ä¸œè¥¿>GPUä¸Šéƒ½å­˜äº†å“ªäº›ä¸œè¥¿</a></li><li><a href=#%e6%b7%b7%e5%90%88%e7%b2%be%e5%ba%a6%e8%ae%ad%e7%bb%83 aria-label=æ··åˆç²¾åº¦è®­ç»ƒ>æ··åˆç²¾åº¦è®­ç»ƒ</a></li></ul></li><li><a href=#%e9%87%8f%e5%8c%96%e5%88%86%e6%9e%90 aria-label=é‡åŒ–åˆ†æ>é‡åŒ–åˆ†æ</a><ul><li><a href=#transformer%e7%bb%93%e6%9e%84%e8%af%a6%e8%a7%a3 aria-label=transformerç»“æ„è¯¦è§£>transformerç»“æ„è¯¦è§£</a><ul><ul><ul><li><a href=#%e7%ae%80%e5%8d%95%e5%88%86%e6%9e%90 aria-label=ç®€å•åˆ†æ>ç®€å•åˆ†æ</a></li><li><a href=#%e5%85%b6%e4%bb%96%e8%af%b4%e6%98%8e aria-label=å…¶ä»–è¯´æ˜>å…¶ä»–è¯´æ˜</a><ul><li><a href=#1-layernorm%e7%9a%84%e8%ae%a1%e7%ae%97 aria-label="1. LayerNormçš„è®¡ç®—">1. LayerNormçš„è®¡ç®—</a></li><li><a href=#2-layernorm%e7%9a%84%e4%bd%8d%e7%bd%ae aria-label="2. LayerNormçš„ä½ç½®">2. LayerNormçš„ä½ç½®</a></li><li><a href=#3-%e5%85%b3%e4%ba%8edropout%e7%9a%84%e4%bd%8d%e7%bd%ae aria-label="3. å…³äºdropoutçš„ä½ç½®">3. å…³äºdropoutçš„ä½ç½®</a></li></ul></li></ul></ul></ul></li></ul></li></ul></div></details></div><div class=post-content><h1 id=å®šæ€§åˆ†æ>å®šæ€§åˆ†æ<a hidden class=anchor aria-hidden=true href=#å®šæ€§åˆ†æ>Â¶</a></h1><h2 id=gpuä¸Šéƒ½å­˜äº†å“ªäº›ä¸œè¥¿>GPUä¸Šéƒ½å­˜äº†å“ªäº›ä¸œè¥¿<a hidden class=anchor aria-hidden=true href=#gpuä¸Šéƒ½å­˜äº†å“ªäº›ä¸œè¥¿>Â¶</a></h2><p>é¦–å…ˆæˆ‘ä»¬æ¥ä»å…¨å±€æ•´ä½“çš„è§’åº¦çœ‹ä¸€çœ‹ï¼Œåœ¨è®­ç»ƒé˜¶æ®µGPUæ˜¾å­˜ä¸Šéƒ½æœ‰å“ªäº›å†…å®¹ï¼š</p><ul><li>Model Statesï¼šæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­å¿…é¡»å­˜å‚¨çš„states<ul><li>paramsï¼ˆä¸‹é¢æœ‰æ—¶ä¹Ÿå«åšweightsï¼‰ï¼šæ¨¡å‹å‚æ•°ï¼Œè®°å‚æ•°é‡ä¸º$\Phi$</li><li>gradsï¼šæ¨¡å‹æ¢¯åº¦ï¼Œæ¢¯åº¦æ•°é‡åŒå‚æ•°é‡$\Phi$</li><li>optimizer statesï¼šAdamä¼˜åŒ–å™¨ä¸­çš„momentumå’Œvarianceï¼Œæ•°é‡åˆ†åˆ«æ˜¯$\Phi$ï¼Œå…±$2\Phi$</li></ul></li><li>Residual Statesï¼šæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä¸­é—´ä¸´æ—¶çš„ã€åŠ¨æ€äº§ç”Ÿçš„states<ul><li>activationï¼šä¸­é—´æ¿€æ´»å€¼ï¼Œè¿™ä¸ªéƒ¨åˆ†å¯èƒ½åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å æ®å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¾å­˜ï¼Œä¸‹é¢ä¼šè¯¦ç»†åˆ†æã€‚ä½†æ˜¯æ¿€æ´»å€¼ä¸æ˜¯å¿…é¡»å­˜å‚¨çš„ï¼Œå¯ä»¥ä½¿ç”¨é‡è®¡ç®—ï¼ˆrecomputeï¼Œä¹Ÿå«åšactivation checkpointï¼‰ï¼Œåœ¨åå‘ç®—æ¢¯åº¦çš„æ—¶å€™ï¼Œå†é‡æ–°ç®—ä¸€éï¼Œå½“ç„¶è®¡ç®—å¢åŠ äº†ï¼Œæ—¶é—´æ¢ç©ºé—´ï¼Œå®é™…ä½¿ç”¨ä¸­å¯ä»¥éƒ¨åˆ†é€‰æ‹©æ€§çš„è¿›è¡Œé‡è®¡ç®—ã€‚</li><li>temporary buffersï¼šä¸´æ—¶å­˜å‚¨ï¼Œæ¯”å¦‚cudaã€ncclç­‰ä¸´æ—¶ç”³è¯·çš„æ˜¾å­˜ã€‚</li><li>unusable fragment memoryï¼šå†…å­˜ç¢ç‰‡å¯¼è‡´çš„å†…å­˜æµªè´¹</li></ul></li></ul><p>æ¨ç†é˜¶æ®µå°±ç›¸å¯¹ç®€å•ä¸€äº›ï¼Œæœ€ä¸»è¦çš„æ˜¯Model Statesä¸­çš„paramså’ŒResidual Statesä¸­çš„activationã€‚</p><p>å‚è€ƒï¼š<a href=https://zhuanlan.zhihu.com/p/618865052>å›¾è§£å¤§æ¨¡å‹è®­ç»ƒä¹‹ï¼šæ•°æ®å¹¶è¡Œä¸‹ç¯‡( DeepSpeed ZeROï¼Œé›¶å†—ä½™ä¼˜åŒ–)</a></p><h2 id=æ··åˆç²¾åº¦è®­ç»ƒ>æ··åˆç²¾åº¦è®­ç»ƒ<a hidden class=anchor aria-hidden=true href=#æ··åˆç²¾åº¦è®­ç»ƒ>Â¶</a></h2><p>ä¸Šé¢åªæ˜¯åˆ—å‡ºäº†è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ˜¾å­˜ä¸­å­˜æ”¾çš„å†…å®¹å’Œä¿å­˜çš„æ•°å€¼æ•°é‡ï¼Œä½†æ˜¯å®é™…è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä¸ºäº†èŠ‚çœæ˜¾å­˜ï¼Œä»¥åŠè€ƒè™‘åˆ°è®­ç»ƒè¿‡ç¨‹ä¸­é—´æŸäº›è¿‡ç¨‹å¯¹ç²¾åº¦ä¸æ˜¯ç‰¹åˆ«æ•æ„Ÿï¼Œæ‰€ä»¥ä¸­é—´æœ‰äº›éƒ¨åˆ†ä¼šä½¿ç”¨fp32ï¼Œæœ‰äº›éƒ¨åˆ†ä¼šä½¿ç”¨fp16/bf16ã€‚ä¸‹é¢ä»¥Megatronä¸ºä¾‹ï¼Œç®€å•åˆ†ææ··åˆç²¾åº¦è®­ç»ƒçš„ä¸€ä¸ªå¤§è‡´æµç¨‹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒçš„åœºæ™¯ï¼Œæ•°å€¼ç²¾åº¦å…¨ä½¿ç”¨fp32ï¼Œä½œä¸ºä¸€ä¸ªåˆ†æçš„baselineã€‚å…·ä½“è¿‡ç¨‹æ˜¯ï¼š</p><img src=https://cdn.jsdelivr.net/gh/QinganZhang/ImageHosting/img/2024-09-07-21:18:21.png alt=fp32ç²¾åº¦è®­ç»ƒ style=zoom:40%><p>å ç”¨æ˜¾å­˜ä¸ºï¼š$4\Phi$ï¼ˆfp32 weightsï¼‰+$4\Phi$ï¼ˆfp32 momentumï¼‰+$4\Phi$ï¼ˆfp32 varianceï¼‰+$4\Phi$ï¼ˆfp32 gradï¼‰+fp32 activationï¼ˆå¯èƒ½å¾ˆå¤§ï¼‰=$16\Phi$ Bytes + fp32 activationï¼ˆ4ä»£è¡¨fp32çš„4Bytesï¼Œ2ä»£è¡¨fp16/bf16çš„2Bytesï¼‰</p><p>å¦‚æœä½¿ç”¨fp16çš„æ··åˆç²¾åº¦è®­ç»ƒï¼ˆbf16åº”è¯¥ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯å®é™…Megatronæœ‰ç‚¹ä¸åŒï¼Œä¸‹é¢ä¼šæåˆ°ï¼‰ï¼Œå…·ä½“è¿‡ç¨‹æ˜¯ï¼š</p><img src=C:\Users\zhang\Desktop\fp16æ··åˆç²¾åº¦è®­ç»ƒ.png alt=fp16æ··åˆç²¾åº¦è®­ç»ƒ style=zoom:50%><p>å ç”¨æ˜¾å­˜ä¸ºï¼š$4\Phi$ï¼ˆfp32 weightsï¼‰+$4\Phi$ï¼ˆfp32 momentumï¼‰+$4\Phi$ï¼ˆfp32 varianceï¼‰+$2\Phi$ï¼ˆfp16 gradï¼‰+$2\Phi$ï¼ˆfp16 scaled gradï¼‰+$4\Phi$ï¼ˆfp32 unscaled and cliped gradï¼‰+fp16 activationï¼ˆå¯èƒ½å¾ˆå¤§ï¼‰=$20\Phi$ Bytes + fp16 activation</p><p>éœ€è¦è¯´æ˜çš„æœ‰ä¸¤ç‚¹ï¼š</p><ol><li>å½“fp16 scaled gradè½¬ä¸ºä¸ºfp32 unscaled and cliped gradåï¼Œfp16 scaled gradå°±æ²¡ç”¨äº†ï¼Œä½†æ˜¯æ­¤æ—¶Megatronä¸­ä»ç„¶ä¿ç•™ç€ä¸€ä»½fp16 scaled gradï¼Œæ‰€ä»¥æ˜¾å­˜å ç”¨ä¸­è¿™ä¸¤éƒ¨åˆ†éƒ½ä¼šè®¡ç®—åœ¨å†…ï¼Œè¿™ä¹Ÿç¬¦åˆMegatron offical readmeä¸­çš„æè¿°ï¼š</li></ol><img src=C:\Users\zhang\AppData\Roaming\Typora\typora-user-images\image-20240907213340085.png alt=image-20240907213340085 style=zoom:80%><ol start=2><li><p>æ³¨æ„åˆ°ä¸Šé¢æµç¨‹ä¸­å¤šäº†ä¸€ä¸ªscale/unscaleçš„æ“ä½œï¼Œè¿™å«åšâ€œloss scalingâ€</p><p>â€‹ åœ¨ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒæ—¶ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨fp16çš„gradæ¥æ›´æ–°fp16çš„æ¢¯åº¦ï¼Œä¸€æ˜¯ä¼šäº§ç”Ÿèˆå…¥è¯¯å·®ï¼ˆæ¯”å¦‚æ¢¯åº¦å¾ˆå°ï¼Œæƒé‡æ›´æ–°åï¼Œç”±äºç²¾åº¦ä¸å¤Ÿï¼Œç´¯åŠ ä¸Šçš„lr * gradè¢«èˆå…¥ï¼Œæƒé‡æ²¡å˜ï¼Œä¸€å¥è¯æ¥è¯´å°±æ˜¯<strong>å¤§æ•°åƒå°æ•°</strong>ï¼‰ï¼ŒäºŒæ˜¯ä¼šäº§ç”Ÿæ¢¯åº¦ä¸‹æº¢ï¼ˆæ¯”å¦‚æ¢¯åº¦è¿‡å°ï¼Œfp16èŒƒå›´ä¸å¤Ÿï¼Œå¯¼è‡´å¾ˆå°çš„æ¢¯åº¦ä¸‹æº¢æˆä¸º0ï¼Œè€Œè¿™æ ·çš„å°æ¢¯åº¦å æ¯”å¾ˆå¤§ï¼Œä¸€å¥è¯æ¥è¯´å°±æ˜¯<strong>ä¸‹æº¢æˆ0</strong>ï¼‰ã€‚å¯¹äºèˆå…¥è¯¯å·®ï¼Œå¯ä»¥åœ¨æ›´æ–°æƒé‡æ—¶ï¼Œå°†fp16çš„æ¢¯åº¦è½¬æ¢ä¸ºfp32ï¼Œå†æ›´æ–°fp32çš„æƒé‡ï¼Œä»è€Œé¿å…ç²¾åº¦é—®é¢˜ã€‚å¯¹äºæ¢¯åº¦ä¸‹æº¢ï¼Œéœ€è¦ä½¿ç”¨loss scaleã€‚</p><p>â€‹ loss scaleå°±æ˜¯FWDè®¡ç®—å‡ºlossåï¼Œå¯¹lossæ”¾å¤§è‹¥å¹²å€ï¼Œç”±äºæ±‚å¯¼çš„é“¾å¼æ³•åˆ™ï¼Œæ”¾å¤§çš„è‹¥å¹²å€åŒæ ·ä¼šä¼ å¯¼åˆ°fp16æ¢¯åº¦ï¼Œè¿™æ ·fp16æ¢¯åº¦å°±ä¸ä¼šäº§ç”Ÿæ¢¯åº¦ä¸‹æº¢ã€‚åœ¨æ›´æ–°æƒé‡æ—¶ï¼Œå°†fp16çš„æ¢¯åº¦è½¬æ¢ä¸ºfp32ï¼ŒåŒæ—¶è¿›è¡Œunscaleã€‚</p></li></ol><p>åˆšæ‰è¯´åˆ°bf16æœ‰ä¸€ç‚¹ç‚¹ç‰¹æ®Šï¼Œæˆ‘ä»¬çœ‹ç›¸åº”çš„ä»£ç ï¼šï¼ˆMegatronä¸­çš„arguments.pyï¼‰</p><img src=https://cdn.jsdelivr.net/gh/QinganZhang/ImageHosting/img/2024-09-07-21:49:42.png alt=image-20240907214939077 style=zoom:80%><p>æ³¨æ„åˆ°å¦‚æœä½¿ç”¨bf16ï¼Œé‚£ä¹ˆä¼šå¼ºè¡Œè®¾ç½®accumulate_allreduce_grads_in_fp32=Trueï¼Œè¿™ä¸ä¸Šé¢Megatron offical readmeæˆªå›¾ï¼ˆDistributed Optimizerï¼‰è¡¨æ ¼ä¸­çš„ç¬¬äºŒè¡Œã€bf16 param, fp32 gradsã€‘ç›¸å¯¹åº”ã€‚å…·ä½“è¿‡ç¨‹åº”è¯¥æ˜¯ï¼ˆnot for sure, hope for discussï¼‰ï¼š</p><blockquote><p>accumulate_allreduce_grads_in_fp32ï¼šIf true, do the gradient accumulation and communication in fp32. <a href=https://docs.nvidia.com/megatron-core/developer-guide/latest/api-guide/distributed.html>from here</a></p><p>gradient accumulationï¼šåœ¨è‹¥å¹²æ¬¡iterationä¸­ï¼Œæ¯æ¬¡éƒ½ä¼šåå‘å¾—åˆ°ä¸€ä»½æ¢¯åº¦ï¼Œå°†è¿™è‹¥å¹²æ¬¡iterationå¾—åˆ°çš„æ¢¯åº¦è¿›è¡Œç´¯åŠ ã€æ±‚å¹³å‡ï¼Œåœ¨æœ€åä¸€æ¬¡iterationæ‰æ›´æ–°æƒé‡ã€‚gradient accumulationä¸data parallelæ˜¯ç­‰ä»·çš„ï¼Œgradient accumulationåœ¨æ—¶é—´ç»´åº¦ä¸Šè®­ç»ƒå¤šä¸ªmini-batchï¼Œè€Œdata parallelåœ¨ç›¸åŒæ—¶é—´å†…å°†ä¸åŒmini-batchæ”¾åœ¨ä¸åŒçš„æœºå™¨ä¸Šè®­ç»ƒï¼Œç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>å‚è€ƒï¼š</p><ul><li><p><a href=https://zhuanlan.zhihu.com/p/595716023>èŠèŠæ¢¯åº¦ç´¯åŠ (Gradient Accumulation)</a></p></li><li><p><a href=https://zhuanlan.zhihu.com/p/650710443>æ¢¯åº¦ç´¯ç§¯ç®—æ³•</a></p></li><li><p><a href=https://huggingface.co/docs/accelerate/usage_guides/gradient_accumulation>Hugging Face:Performing gradient accumulation with ğŸ¤— Accelerate</a></p></li></ul></blockquote><img src=C:\Users\zhang\Desktop\bf16æ··åˆç²¾åº¦è®­ç»ƒ.png alt=bf16æ··åˆç²¾åº¦è®­ç»ƒ style=zoom:50%><p>è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªä¸ºä»€ä¹ˆè¦å°†bf16ä¸accumulate_allreduce_grads_in_fp32ç»‘å®šçš„<a href=https://github.com/NVIDIA/Megatron-LM/issues/372>issue</a>ï¼Œé‡Œé¢æåˆ°â€œWe found this to lead to more stable training before, but you could also try to perform the all-reduce in <code>bf16</code> (it might hurt convergence but will be faster).â€</p><p>å‚è€ƒï¼š</p><ul><li><a href=https://zhuanlan.zhihu.com/p/618865052>å›¾è§£å¤§æ¨¡å‹è®­ç»ƒä¹‹ï¼šæ•°æ®å¹¶è¡Œä¸‹ç¯‡( DeepSpeed ZeROï¼Œé›¶å†—ä½™ä¼˜åŒ–)</a></li><li><a href=https://zhuanlan.zhihu.com/p/662700424>å›¾è§£å¤§æ¨¡å‹è®­ç»ƒç³»åˆ—ä¹‹ï¼šMegatronæºç è§£è¯»3ï¼Œåˆ†å¸ƒå¼æ··åˆç²¾åº¦è®­ç»ƒ</a></li><li><a href=https://docs.nvidia.com/deeplearning/performance/mixed-precision-training>NVIDIA Docs Hubï¼šTrain With Mixed Precision</a></li><li><a href=https://zhuanlan.zhihu.com/p/441591808>å…¨ç½‘æœ€å…¨-æ··åˆç²¾åº¦è®­ç»ƒåŸç†</a></li></ul><h1 id=é‡åŒ–åˆ†æ>é‡åŒ–åˆ†æ<a hidden class=anchor aria-hidden=true href=#é‡åŒ–åˆ†æ>Â¶</a></h1><h2 id=transformerç»“æ„è¯¦è§£>transformerç»“æ„è¯¦è§£<a hidden class=anchor aria-hidden=true href=#transformerç»“æ„è¯¦è§£>Â¶</a></h2><p>LLMä¸­çš„transformerä¸€èˆ¬æ˜¯decoder-onlyç»“æ„ï¼Œæ‰€ä»¥ä¸‹é¢çš„transformer blockä¸»è¦æ˜¯decoderï¼Œä½†æ˜¯ä¸ç»å…¸çš„Transformerä¸­çš„decoderä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œæ²¡æœ‰äº†cross-attnï¼Œå› æ­¤ç»“æ„çœ‹èµ·æ¥åè€Œæœ‰ç‚¹åƒencoderï¼ˆä½†ä¸æ˜¯ï¼Œå› ä¸ºæœ‰casual maskï¼‰ã€‚</p><p>ä¸‹é¢å›¾ä¸­çš„Transformerï¼Œæ²¡æœ‰ä¸Škv-cacheã€GQAç­‰ä¼˜åŒ–ï¼Œè¿™éƒ¨åˆ†åé¢ä¼šåˆ†æã€‚å…¶ä¸­ï¼Œå‚æ•°é‡$\Phi$è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªå‚æ•°ï¼›ä¸­é—´æ¿€æ´»å€¼$A$æ˜¯ï¼Œå•ä½æ˜¯Bytesï¼Œ</p><img src=https://cdn.jsdelivr.net/gh/QinganZhang/ImageHosting/img/2024-09-04-22:12:10.jpg alt=20240904221135 style=zoom:150%><p>KV cacheå¯¹æ˜¾å­˜å ç”¨çš„å½±å“</p><p>MQAå’ŒGQAå¯¹æ˜¾å­˜å ç”¨çš„å½±å“</p><h5 id=ç®€å•åˆ†æ>ç®€å•åˆ†æ<a hidden class=anchor aria-hidden=true href=#ç®€å•åˆ†æ>Â¶</a></h5><p>å¿½ç•¥å±‚æ•°lï¼Œæ‹¿å•å±‚æ¥è¿›è¡Œåˆ†æ</p><ol><li><p>å‚æ•°é‡ä¸éšè—å±‚ç»´åº¦hçš„å¹³æ–¹æˆæ­£æ¯”</p></li><li><p>æ¿€æ´»å€¼ä¸­é—´åŒ…å«ä¸¤é¡¹ï¼Œ$34bsh$å’Œ$8bas^2$ï¼Œæå–å‡ºç›¸åŒçš„éƒ¨åˆ†ï¼Œå‰©ä¸‹å³æ¯”è¾ƒ$34h$å’Œ$8as$çš„å¤§å°,ä¸€èˆ¬æ¥è¯´8asä¼šå¤§ä¸€ç‚¹ï¼ˆå¦‚æœæ²¡ç”¨MQAæˆ–GQAï¼‰ï¼Œæ˜¯34hçš„2~10å€ï¼Œå› æ­¤å¢å¤§bã€sã€héƒ½ä¼šæ˜¾è‘—å¢åŠ æ¿€æ´»å€¼å ç”¨çš„æ˜¾å­˜ï¼Œä¸¾ä¸ªä¾‹å­è¯´æ˜ï¼š</p><table><thead><tr><th>configï¼ˆå‡è®¾ä½¿ç”¨bf16ï¼‰</th><th>$34bsh$</th><th>$8bas^2$</th><th>total</th></tr></thead><tbody><tr><td>b=1,s=2048,a=96,h=12288</td><td>816MB</td><td>3072MB</td><td>3.8G</td></tr></tbody></table></li><li><p>è®¡ç®—é‡ä¸å‚æ•°é‡æˆæ­£æ¯”ï¼Œä¸è¾“å…¥tokenæ•°é‡æˆæ­£æ¯”</p></li></ol><h5 id=å…¶ä»–è¯´æ˜>å…¶ä»–è¯´æ˜<a hidden class=anchor aria-hidden=true href=#å…¶ä»–è¯´æ˜>Â¶</a></h5><h6 id=1-layernormçš„è®¡ç®—>1. LayerNormçš„è®¡ç®—<a hidden class=anchor aria-hidden=true href=#1-layernormçš„è®¡ç®—>Â¶</a></h6><p>LayerNormçš„è®¡ç®—è¿‡ç¨‹è§<a href=https://blog.csdn.net/weixin_39228381/article/details/107939602>pytorch LayerNormå‚æ•°è¯¦è§£ï¼Œè®¡ç®—è¿‡ç¨‹</a>ï¼Œæ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š</p><ol><li>æ¯”å¦‚è¾“å…¥æ˜¯<code>[b,s,h]</code>ï¼ŒLNçš„<code>normalized_shape=[h]</code>ï¼Œæ­¤æ—¶å°±æ˜¯å¯¹æ¯ä¸€ä¸ªå¤§å°ä¸º<code>h</code>çš„å‘é‡åˆ†åˆ«è¿›è¡Œå½’ä¸€åŒ–ï¼ˆä¸€å…±<code>b*s</code>ä¸ªï¼‰</li><li>ç„¶åå¦‚æœLNçš„<code>elementwise_affine=True</code>ï¼Œå°±éœ€è¦å¯¹æ¯ä¸ªå¤§å°ä¸º<code>h</code>çš„å‘é‡elementwiseçš„ä¹˜ä¸Š$\gamma: [h]$ï¼Œå†elementwiseçš„åŠ ä¸Š$\beta:[h]$ï¼Œ$\gamma$å’Œ$\beta$å°±æ˜¯è¯¥LNå±‚çš„ä¸¤ä¸ªå¯å­¦ä¹ çš„å‚æ•°ã€‚å¦‚æœLNçš„<code>elementwise_affine=False</code>ï¼Œåˆ™åªä¼šè¿›è¡Œç¬¬ä¸€æ­¥çš„å½’ä¸€åŒ–ï¼Œä¸ä¼šè¿›è¡Œç¬¬äºŒæ­¥çš„affine</li></ol><p>ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜æ˜¯ï¼Œ<a href=https://zhuanlan.zhihu.com/p/707778968>Transformerä¸­çš„LayerNormå¯ä»¥å¹¶è¡Œå—ï¼Ÿ</a></p><p>å…³é”®è¯ï¼š Welford online Algorithmï¼Œå½“ä¸€ä¸ªé›†åˆæ–°å¢åŠ ä¸€ä¸ªå…ƒç´ $x_N$çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡å‰N-1ä¸ªæ ·æœ¬çš„corrected sum of squares($\sum_{i=1}^{N-1}(x_i-\bar{x})^2$)ï¼Œè®¡ç®—å‡ºå‰Nä¸ªæ ·æœ¬çš„corrected sum of squaresï¼Œä»è€Œåªéœ€è¦one passå°±å¯ä»¥å®ŒæˆLNçš„è®¡ç®—ï¼ˆä¹‹å‰navieçš„æ–¹æ³•æ˜¯two passï¼‰</p><h6 id=2-layernormçš„ä½ç½®>2. LayerNormçš„ä½ç½®<a hidden class=anchor aria-hidden=true href=#2-layernormçš„ä½ç½®>Â¶</a></h6><p><img loading=lazy src=https://cdn.jsdelivr.net/gh/QinganZhang/ImageHosting/img/2024-09-04-22:22:22.png alt=image-20240904222219836></p><p>åŸå§‹Transformerä¸­ä½¿ç”¨post-normå±…å¤šï¼Œåæ¥ä½¿ç”¨pre-normå±…å¤šï¼Œè€Œä¸”å¾€å¾€åœ¨FFNä¹‹å‰ä¹ŸåŠ ä¸€ä¸ªnormã€‚å°¤å…¶åœ¨å¤§æ¨¡å‹ä¸­ï¼Œå¯èƒ½åœ¨é€šè¿‡LNä¹‹åMHAä¹‹å‰ï¼ŒQå’ŒKè¿˜è¦åŠ ä¸Šæ—‹è½¬ä½ç½®ç¼–ç ã€‚</p><p>å‚è€ƒï¼š<a href=https://zhuanlan.zhihu.com/p/474988236>ã€é‡æ–°äº†è§£Transformeræ¨¡å‹ç³»åˆ—_1ã€‘PostNorm/PreNormçš„å·®åˆ«</a></p><h6 id=3-å…³äºdropoutçš„ä½ç½®>3. å…³äºdropoutçš„ä½ç½®<a hidden class=anchor aria-hidden=true href=#3-å…³äºdropoutçš„ä½ç½®>Â¶</a></h6><p>ä¸€å…±ï¼ˆå¯èƒ½ï¼‰åœ¨æœ‰å››ä¸ªåœ°æ–¹æœ‰dropoutï¼š</p><ol><li>åœ¨PositionalEmbeddingä¸­æœ‰ä¸€ä¸ªdropoutï¼š<code>dropout(x + PositionEmbedding(x))</code>ï¼Œä¸è¿‡å¥½åƒLLMç°åœ¨ä½¿ç”¨æ—‹è½¬ä½ç½®ç¼–ç RoPEå¤šä¸€äº›ï¼Œåœ¨è®¡ç®—attentionä¹‹å‰åœ¨Qå’ŒKä¸ŠåŠ ä¸ŠRoPEï¼Œä¸€å¼€å§‹è¾“å…¥çš„embeddingä¸åŠ PositionalEmbeddingäº†</li><li>åœ¨softmaxè®¡ç®—å¾—åˆ°çš„attention scoreä¹‹åæœ‰ä¸€ä¸ªdroputï¼š$dropout( softmax(\frac{QK^T}{scale}+casual_mask) )$</li><li>åœ¨sublayerï¼ˆAttentionå’ŒMLPï¼‰è®¡ç®—å®Œä¹‹åï¼Œå„æœ‰ä¸€ä¸ªdropoutï¼š<code>x+dropout(sublayer(norm(x)))</code></li></ol><p>å‚è€ƒï¼š</p><p><a href=https://zhuanlan.zhihu.com/p/624740065>åˆ†ætransformeræ¨¡å‹çš„å‚æ•°é‡ã€è®¡ç®—é‡ã€ä¸­é—´æ¿€æ´»ã€KV cache</a></p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://qinganzhang.github.io/posts/encoder-decoder%E5%92%8Cdecoder-only%E6%9E%B6%E6%9E%84%E8%AE%AD%E7%BB%83%E5%92%8C%E6%8E%A8%E7%90%86%E6%B5%85%E6%9E%90/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>Encoder Decoderå’Œdecoder Onlyæ¶æ„è®­ç»ƒå’Œæ¨ç†æµ…æ</span>
</a><a class=next href=https://qinganzhang.github.io/posts/a_survey_of_efficient_transformer_on_inference/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>A survey of Efficient Transformer on Inference</span></a></nav></footer><div class=comments-separator></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://qinganzhang.github.io/>Paul's Blog</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a>
</span><span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a="1"=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>