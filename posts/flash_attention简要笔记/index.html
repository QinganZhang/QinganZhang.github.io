<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>flash_attentionç®€è¦ç¬”è®° | Paul's Blog</title>
<meta name=keywords content="deep learning"><meta name=description content="æœ¬æ–‡ä¸­æœ‰è¾ƒå¤šLatexæ•°å­¦å…¬å¼ï¼Œåšå®¢ä¸Šæœ‰ä¸€äº›æ•°å­¦å…¬å¼æ ¼å¼æ¸²æŸ“ä¸æ­£ç¡®ï¼Œå¯ä»¥æŸ¥çœ‹flash_attentionç®€è¦ç¬”è®° ä¼˜åŒ–æ•ˆæœ åŸæ¥ï¼Œattent"><meta name=author content="Paul"><link rel=canonical href=https://qinganzhang.github.io/posts/flash_attention%E7%AE%80%E8%A6%81%E7%AC%94%E8%AE%B0/><link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style><link rel=icon href=https://qinganzhang.github.io/favicon.ico><link rel=apple-touch-icon href=https://qinganzhang.github.io/apple-touch-icon.png><meta name=twitter:title content="flash_attentionç®€è¦ç¬”è®° | Paul's Blog"><meta name=twitter:description content="æœ¬æ–‡ä¸­æœ‰è¾ƒå¤šLatexæ•°å­¦å…¬å¼ï¼Œåšå®¢ä¸Šæœ‰ä¸€äº›æ•°å­¦å…¬å¼æ ¼å¼æ¸²æŸ“ä¸æ­£ç¡®ï¼Œå¯ä»¥æŸ¥çœ‹flash_attentionç®€è¦ç¬”è®° ä¼˜åŒ–æ•ˆæœ åŸæ¥ï¼Œattent"><meta property="og:title" content="flash_attentionç®€è¦ç¬”è®° | Paul's Blog"><meta property="og:description" content="æœ¬æ–‡ä¸­æœ‰è¾ƒå¤šLatexæ•°å­¦å…¬å¼ï¼Œåšå®¢ä¸Šæœ‰ä¸€äº›æ•°å­¦å…¬å¼æ ¼å¼æ¸²æŸ“ä¸æ­£ç¡®ï¼Œå¯ä»¥æŸ¥çœ‹flash_attentionç®€è¦ç¬”è®° ä¼˜åŒ–æ•ˆæœ åŸæ¥ï¼Œattent"><meta property="og:type" content="article"><meta property="og:url" content="https://qinganzhang.github.io/posts/flash_attention%E7%AE%80%E8%A6%81%E7%AC%94%E8%AE%B0/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-07T14:07:19+08:00"><meta property="article:modified_time" content="2024-09-07T14:07:19+08:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Post","item":"https://qinganzhang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"flash_attentionç®€è¦ç¬”è®°","item":"https://qinganzhang.github.io/posts/flash_attention%E7%AE%80%E8%A6%81%E7%AC%94%E8%AE%B0/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"flash_attentionç®€è¦ç¬”è®° | Paul's Blog","name":"flash_attentionç®€è¦ç¬”è®°","description":"æœ¬æ–‡ä¸­æœ‰è¾ƒå¤šLatexæ•°å­¦å…¬å¼ï¼Œåšå®¢ä¸Šæœ‰ä¸€äº›æ•°å­¦å…¬å¼æ ¼å¼æ¸²æŸ“ä¸æ­£ç¡®ï¼Œå¯ä»¥æŸ¥çœ‹flash_attentionç®€è¦ç¬”è®° ä¼˜åŒ–æ•ˆæœ åŸæ¥ï¼Œattent","keywords":["deep learning"],"wordCount":"5267","inLanguage":"en","datePublished":"2024-09-07T14:07:19+08:00","dateModified":"2024-09-07T14:07:19+08:00","author":{"@type":"Person","name":"Paul"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://qinganzhang.github.io/posts/flash_attention%E7%AE%80%E8%A6%81%E7%AC%94%E8%AE%B0/"},"publisher":{"@type":"Organization","name":"Paul's Blog","logo":{"@type":"ImageObject","url":"https://qinganzhang.github.io/favicon.ico"}}}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.css integrity=sha384-bYdxxUwYipFNohQlHt0bjN/LCpueqWz13HufFEV1SUatKs1cm4L6fFgCi1jT643X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.js integrity=sha384-Qsn9KnoKISj6dI8g7p1HBlNpVx0I8p1SvlwOldgi3IorMle61nQy4zEahWYtljaz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary-bg:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list-page{background:var(--theme)}.list-page:not(.dark)::-webkit-scrollbar-track{background:0 0}.list-page:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body class="type-posts kind-page layout-" id=top><script data-no-instant>function switchTheme(e){switch(e){case"light":document.body.classList.remove("dark");break;case"dark":document.body.classList.add("dark");break;default:window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")}}function isDarkTheme(){return document.body.className.includes("dark")}function getPrefTheme(){return localStorage.getItem("pref-theme")}function setPrefTheme(e){switchTheme(e),localStorage.setItem("pref-theme",e)}const toggleThemeCallbacks={};toggleThemeCallbacks.main=e=>{setPrefTheme(e?"light":"dark")},window.addEventListener("toggle-theme",function(){const e=isDarkTheme();for(const t in toggleThemeCallbacks)toggleThemeCallbacks[t](e)});function toggleThemeListener(){window.dispatchEvent(new CustomEvent("toggle-theme"))}</script><script>(function(){const t="auto",e=getPrefTheme(),n=e||t;switchTheme(n)})()</script><header class=header><nav class=nav><div class=logo><a href=https://qinganzhang.github.io/ accesskey=h title="Paul's Blog (Alt + H)">Paul's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://qinganzhang.github.io/posts/ title=Posts class=active>Posts</a></li><li><a href=https://qinganzhang.github.io/archives/ title=Archive>Archive</a></li><li><a href=https://qinganzhang.github.io/search/ title="Search (Alt + /)" data-no-instant accesskey=/>Search</a></li><li><a href=https://qinganzhang.github.io/tags/ title=Tags>Tags</a></li><li><a href=https://qinganzhang.github.io/categories/ title=Categories>Categories</a></li><li><a href=https://qinganzhang.github.io/about/ title=About>About</a></li></ul></nav></header><main class="main post"><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://qinganzhang.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://qinganzhang.github.io/posts/>Post</a></div><h1 class=post-title>flash_attentionç®€è¦ç¬”è®°</h1><div class=post-meta><span class=meta-item><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg>
<span>2024-09-07</span></span><span class=meta-item>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select:text"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" style="user-select:text"/><line x1="7" y1="7" x2="7" y2="7" style="user-select:text"/></svg>
<span class=post-tags><a href=https://qinganzhang.github.io/tags/deep-learning/>deep learning</a></span></span><span class=meta-item>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg>
<span>5267 words</span></span><span class=meta-item>
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>11 min</span></span></div></header><div class="toc side right"><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%bc%98%e5%8c%96%e6%95%88%e6%9e%9c aria-label=ä¼˜åŒ–æ•ˆæœ>ä¼˜åŒ–æ•ˆæœ</a></li><li><a href=#%e5%85%b7%e4%bd%93%e8%bf%87%e7%a8%8b aria-label=å…·ä½“è¿‡ç¨‹>å…·ä½“è¿‡ç¨‹</a></li><li><a href=#%e7%ae%80%e8%a6%81%e5%88%86%e6%9e%90 aria-label=ç®€è¦åˆ†æ>ç®€è¦åˆ†æ</a></li><li><a href=#%e5%ae%9e%e9%99%85%e4%bd%bf%e7%94%a8 aria-label=å®é™…ä½¿ç”¨>å®é™…ä½¿ç”¨</a><ul><li><a href=#%e6%8e%a5%e5%8f%a3%e8%bf%94%e5%9b%9e%e5%80%bc aria-label=æ¥å£è¿”å›å€¼>æ¥å£è¿”å›å€¼</a></li><li><a href=#varlen-attention aria-label="varlen attention">varlen attention</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=å‚è€ƒ>å‚è€ƒ</a></li></ul></div></details></div><div class=post-content><p>æœ¬æ–‡ä¸­æœ‰è¾ƒå¤šLatexæ•°å­¦å…¬å¼ï¼Œåšå®¢ä¸Šæœ‰ä¸€äº›æ•°å­¦å…¬å¼æ ¼å¼æ¸²æŸ“ä¸æ­£ç¡®ï¼Œå¯ä»¥æŸ¥çœ‹<a href=https://blog.csdn.net/weixin_44343319/article/details/142318098>flash_attentionç®€è¦ç¬”è®°</a></p><h1 id=ä¼˜åŒ–æ•ˆæœ>ä¼˜åŒ–æ•ˆæœ<a hidden class=anchor aria-hidden=true href=#ä¼˜åŒ–æ•ˆæœ>Â¶</a></h1><p>åŸæ¥ï¼Œattentionéƒ¨åˆ†çš„è®¡ç®—é‡å’Œä¸­é—´æ¿€æ´»å ç”¨æ˜¾å­˜çš„å¤æ‚åº¦éƒ½æ˜¯$O(N^2)$</p><blockquote><p>è®¡ç®—é‡éƒ¨åˆ†åŸæ¥QKçŸ©é˜µä¹˜å’Œattn_score@VçŸ©é˜µä¹˜çš„è®¡ç®—é‡ï¼Œå¤æ‚åº¦éƒ½æ˜¯$O(N^2)$ï¼›ä¸­é—´æ¿€æ´»å› ä¸ºä¸­é—´æœ‰ä¸€ä¸ªattn_scoreï¼Œæ‰€ä»¥å¤æ‚åº¦ä¹Ÿæ˜¯$O(N^2)$</p></blockquote><p>ç°åœ¨ï¼Œattentionéƒ¨åˆ†çš„ä¸­é—´æ¿€æ´»å ç”¨æ˜¾å­˜çš„å¤æ‚åº¦å˜ä¸º$O(N)$ï¼Œè®¡ç®—é‡çš„å¤æ‚åº¦æ²¡æœ‰å˜ä½†æ˜¯é€šè¿‡å‡å°‘è®¿å­˜åŠ å¿«äº†è®¡ç®—é€Ÿåº¦ï¼Œè€Œä¸”faä¸åŸattentionå®Œå…¨ç­‰ä»·</p><h1 id=å…·ä½“è¿‡ç¨‹>å…·ä½“è¿‡ç¨‹<a hidden class=anchor aria-hidden=true href=#å…·ä½“è¿‡ç¨‹>Â¶</a></h1><p>flash-attentionè¿˜æ˜¯åŸºäºkernelèåˆçš„æ€æƒ³ï¼Œå°†QKçŸ©é˜µä¹˜æ³•ã€maskã€softmaxã€dropoutåˆå¹¶æˆä¸€ä¸ªkernelï¼Œè¿™æ ·ä¸ä»…å‡å°‘äº†ä¸­é—´å˜é‡å¯¹æ˜¾å­˜çš„å ç”¨ï¼Œè€Œä¸”ä¹Ÿå‡å°‘äº†è®¡ç®—è¿‡ç¨‹ä¸­çš„è®¿å­˜</p><p>ä¸€äº›ç¬¦å·è¡¨ç¤ºï¼š</p><ul><li><p>$S_{ij}=Q_i \times K_j^T$ï¼ŒQåˆ†å—å’ŒKåˆ†å—çš„ä¹˜ç§¯ï¼Œå½¢çŠ¶ä¸º$[B_r, B_c]$</p></li><li><p>$\widetilde{m}<em>{ij}=rowmax(S</em>{ij})$ï¼šå¯¹åˆ†å—$S_{ij}$è€Œè¨€ï¼Œå¾—åˆ°å…¶æ¯è¡Œçš„æœ€å¤§å€¼ï¼Œå½¢çŠ¶ä¸º$[B_r, 1]$</p></li><li><p>$\widetilde{P}<em>{ij}=e^{S</em>{ij}-\widetilde{m}<em>{ij}}=e^{S</em>{ij}-rowmax(S_{ij})}$ï¼šæ¯ä¸ªåˆ†å—$S_{ij}$å‡å»å…¶å±€éƒ¨rowmax $\widetilde{m}_{ij}$ï¼Œå½¢çŠ¶ä¸º$[B_r, B_c]$</p></li><li><p>$\widetilde{l}<em>{ij}=rowsum(\widetilde{P}</em>{ij})=rowsum(e^{S_{ij}-rowmax(S_{ij})})$ï¼šå¯¹$\widetilde{P}_{ij}$è€Œè¨€ï¼ŒæŒ‰è¡Œæ±‚å’Œï¼Œå½¢çŠ¶ä¸º$[B_r, 1]$</p></li><li><p>$m^{new}<em>i=max(\widetilde{m}</em>{i0}, \widetilde{m}<em>{i1}, &mldr; , \widetilde{m}</em>{ij})=rowmax(concat(S_{i0}, S_{i1}, &mldr; , S_{ij}))$ï¼šå³$contcat(S_{i0}, S_{i1}, &mldr; , S_{ij})$è¿™j+1ä¸ªåˆ†å—çš„æ¯è¡Œçš„æœ€å¤§å€¼ï¼Œå½¢çŠ¶ä¸º$[Br, 1]$</p></li><li><p>$m_i$ï¼š$m_i^{new}$ä½äºSRAMä¸Šï¼Œå°†$m_i^{new}$å†™å›åˆ°HBMå°±æ˜¯$m_i$ï¼Œåˆå§‹åŒ–$m=-\infty$</p></li><li><p>$l^{new}<em>i=e^{m_i-m_i^{new}}l_i + e^{\widetilde{m}</em>{ij}-m_i^{new}} \widetilde{l}<em>{ij}=rowsum[e^{S</em>{00}-max(\widetilde{m}<em>{00},&mldr;,\widetilde{m}</em>{0j})}] + &mldr; + rowsum[e^{S_{0j}-max(\widetilde{m}<em>{00},&mldr;,\widetilde{m}</em>{0j})}]$ï¼š</p></li><li><p>$l_i$ï¼š$l_i^{new}$ä½äºSRAMä¸Šï¼Œå°†$l_i^{new}$å†™å›åˆ°HBMå°±æ˜¯$l_i$ï¼Œåˆå§‹åŒ–$l=0$</p></li></ul><p>å¦‚æœä¸ä½¿ç”¨flash-attentionï¼Œå…·ä½“è¿‡ç¨‹ä¸ºï¼š</p><ol><li>$S = Q K ^T $</li><li>$P = softmax(S+mask)$</li><li>$O = P V$</li></ol><p>å¦‚æœä½¿ç”¨flash-attentionï¼Œå‰å‘è¿‡ç¨‹ä¸ºï¼š</p><img src=https://cdn.jsdelivr.net/gh/QinganZhang/ImageHosting/img/2024-09-16-23:13:58.png alt=image-20240916230932000 style=zoom:40%><p>å¤§è‡´è¿‡ç¨‹ä¸ºï¼š</p><img src=https://cdn.jsdelivr.net/gh/QinganZhang/ImageHosting/img/2024-09-17-01:47:02.jpg alt=FA style=zoom:100%><ol><li>é¦–å…ˆå¯¹QKVè¿›è¡Œåˆ†å—ï¼ŒKã€Våˆ†å—æ–¹æ³•ç›¸åŒï¼ˆVçš„åˆ†å—å›¾ä¸­æ²¡ç”»å‡ºæ¥ï¼‰ï¼Œé¦–å…ˆå¯ä»¥è®¡ç®—$S_{ij}=Q_i\times K_j^T$ã€‚å› ä¸ºå¯¹QKVè¿›è¡Œäº†åˆ†å—ï¼Œæ‰€ä»¥æ¯æ¬¡SRAMä¸Šèƒ½ä¿ç•™$S_{ij}$å’Œ$\widetilde{P}_{ij}$ï¼ˆæ©™é»„è‰²è¡¨ç¤ºå­˜å‚¨åœ¨SRAMä¸Šï¼›æ©™çº¢è‰²è¡¨ç¤ºè™½ç„¶ä¹Ÿå­˜å‚¨åœ¨SRAMä¸Šï¼Œä½†æ˜¯è¿™äº›éƒ¨åˆ†æ¯æ¬¡outer loopä¼šå†™å›åˆ°HBMä¸­ï¼‰</li><li>å¦‚æœæœ‰maskï¼Œæ­¤æ—¶å¯¹$S_{ij}$è¿›è¡Œmask</li><li>ä½¿ç”¨ä¸€ä¸ªå±€éƒ¨å˜é‡$\widetilde{m}<em>{ij}$å’Œä¸€ä¸ªå…¨å±€å˜é‡$m$ï¼ˆæˆ–è€…è¯´$m^{new}$ï¼Œ$m^{new}$çš„å€¼åœ¨SRAMä¸Šï¼Œä½†æ˜¯æ¯æ¬¡outer loopä¼šå†™å›åˆ°HBMä¸­ï¼‰æ¥è®°å½•åˆ†å—$S</em>{ij}$å±€éƒ¨rowmaxå’Œä¸­é—´éå†è¿‡çš„åˆ†å—$S_{i:}$çš„å†å²rowmax</li><li>ç„¶ååŸºäºåˆ†å—$S_{ij}$è®¡ç®—å±€éƒ¨çš„safe softmaxçš„åˆ†å­éƒ¨åˆ†ï¼Œå³$e^{S_{ij}-rowmax(S_{ij})}$ï¼Œsafe softmaxçš„åˆ†å­éƒ¨åˆ†ç´¯åŠ å°±æ˜¯åˆ†æ¯éƒ¨åˆ†ï¼Œè¿™æ ·ï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªé’ˆå¯¹åˆ†å—$S_{ij}$çš„ã€å±€éƒ¨çš„safe softmaxçš„åˆ†æ¯$\widetilde{l}<em>{ij}$ï¼Œå’Œ ä¸€ä¸ª éå†è¿‡çš„å†å²åˆ†å—$S</em>{i:}$çš„ safe softmaxåˆ†å­éƒ¨åˆ†çš„ ç´¯åŠ å’Œ$l^{new}$ï¼ˆæ³¨æ„æ–­å¥ï¼Œå†™å…¬å¼æœ‰ç‚¹æ™¦æ¶©éš¾æ‡‚ï¼Œç”¨è¯­è¨€æè¿°åˆä¸å¤ªå¥½æè¿°ï¼‰ï¼Œå±€éƒ¨çš„$\widetilde{l}<em>{ij}$å°±æ˜¯ç”¨æ¥æ›´æ–°å…¨å±€çš„$l$ï¼ˆæˆ–è€…è¯´$l^{new}$ï¼Œ$l^{new}$çš„å€¼åœ¨SRAMä¸Šï¼Œä½†æ˜¯æ¯æ¬¡outer loopä¼šå†™å›åˆ°HBMä¸­ï¼‰ï¼Œå¯¹$\widetilde{l}</em>{ij}$ä¸¾ä¸€ä¸ªä¾‹å­ï¼š<ul><li>å½“j=0ï¼Œi=0æ—¶ï¼Œ$l_0^{new}=e^{m_0-m_0^{new}} l_0+e^{\widetilde{m}<em>{00}-m_0^{new}} \widetilde{l}</em>{00}=\widetilde{l}_{00}$</li><li>å½“j=1ï¼Œi=0æ—¶ï¼Œ$l_0^{new} = rowsum(e^{S_{00}-maxâ¡(\widetilde{m}<em>{00}, \widetilde{m}</em>{01})})+rowsum(e^{S_{01}-maxâ¡(\widetilde{m}<em>{00}, \widetilde{m}</em>{01})})$</li></ul></li><li>ç„¶åå¯¹$\widetilde{P}_{ij}$è¿›è¡Œdropout</li><li>ç„¶åç›¸å½“äºè¦è¿›è¡Œ$O+=\widetilde{P}_{ij} V_i$äº†ï¼Œå¯¹äºç®—æ³•çš„ç¬¬15è¡Œï¼Œå¯ä»¥ä½¿ç”¨åˆ†é…å¾‹æ‹†å¼€çœ‹ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªæ“ä½œï¼š<ol><li>ååŠéƒ¨åˆ†ï¼šå¯¹äºå½“å‰çš„$\widetilde{P}<em>{ij} V_i$ç›¸ä¹˜ï¼Œ$\widetilde{P}</em>{ij}$ä¸­å‡å»çš„æ˜¯åˆ†å—$S_{ij}$å±€éƒ¨çš„rowmaxï¼Œéœ€è¦è°ƒæ•´åˆ° æ­¤æ—¶å·²ç»è§è¿‡çš„ã€æ‰€æœ‰åˆ†å—$S_{i:}$çš„rowmaxï¼Œå°±æ˜¯ç¬¬15è¡ŒååŠéƒ¨åˆ†ä¸­$e^{\widetilde{m}_{ij}-m_i^{new}}$çš„æ„æ€</li><li>å‰åŠéƒ¨åˆ†ï¼šè°ƒæ•´ä¸Šä¸€æ¬¡çš„$O$ï¼Œå…ˆä¹˜æ—§çš„$l_i$æ¢å¤åˆ°safe softmaxçš„åˆ†å­éƒ¨åˆ†ï¼Œç„¶åä¹˜ä»¥$e^{m_i-m_i^{new}}$æ›´æ–°ä¸€ä¸‹safe softmaxåˆ†å­éƒ¨åˆ†ä¸­å‡å»çš„å…¨å±€rowmaxï¼Œæœ€åå†é™¤ä»¥å½“å‰çš„safe softmaxçš„åˆ†æ¯</li></ol></li></ol><p>ï¼ˆåå‘è¿‡ç¨‹è¿˜æ˜¯çœ‹åˆ«çš„åšå®¢å§ï¼‰</p><h1 id=ç®€è¦åˆ†æ>ç®€è¦åˆ†æ<a hidden class=anchor aria-hidden=true href=#ç®€è¦åˆ†æ>Â¶</a></h1><p>é¦–å…ˆåˆ†æä¸€ä¸‹façš„FLOPsï¼ˆåªåˆ†æå¤§å—çš„çŸ©é˜µä¹˜æ³•ï¼Œå…¶ä»–å°çš„æ“ä½œå°±ä¸è®¡ç®—äº†ï¼‰ï¼š</p><ul><li>ä¸€å¼€å§‹çš„$Q_i K^T_j$çŸ©é˜µç›¸ä¹˜ï¼Œå…¶ä¸­$Q_i$çš„å½¢çŠ¶ä¸º$[B_r, d]$ï¼Œ$K_j^t$çš„å½¢çŠ¶ä¸º$[d, B_c]$ï¼Œæ­¤æ—¶FLOPs=$2d \times B_r \times B_c$</li><li>åé¢è®¡ç®—Oçš„æ—¶å€™æœ‰ä¸€ä¸ª$\widetilde{P}<em>{ij} V_i$çŸ©é˜µç›¸ä¹˜ï¼Œå…¶ä¸­$\widetilde{P}</em>{ij}$çš„å½¢çŠ¶ä¸º$[B_r, B_c]$ï¼Œ$V_i$çš„å½¢çŠ¶ä¸º$[B_c, d]$ï¼Œæ­¤æ—¶FLOPs=$2B_c \times B_r \times d$ä¸€å…±è¿›è¡Œäº†$\frac{N}{B_r} \times \frac{N}{B_c}$æ¬¡ä¸Šé¢çš„å¾ªç¯ï¼Œæ‰€ä»¥FLOPs=$4N^2d$ï¼Œå¦‚æœdè¿œå°äºNï¼Œåˆ™è®¡ç®—å¤æ‚åº¦å°±å˜æˆäº†$O(N^2)$ï¼Œè®¡ç®—å¤æ‚åº¦ç›¸æ¯”äºstandard attentionæ²¡æœ‰å˜åŒ–</li></ul><p>ç„¶åå†åˆ†æä¸€ä¸‹æ˜¾å­˜å ç”¨ï¼ˆæ˜¾å­˜å ç”¨è¯´çš„æ˜¯HBMä¸Šçš„æ˜¾å­˜å ç”¨ï¼Œå‡è®¾è®¡ç®—ç²¾åº¦ä¸º$w$ Bytesï¼‰</p><ul><li>HBMä¸Šéœ€è¦ç»´æŠ¤ä¸€ä¸ªå…¨å±€çš„rowmaxå’Œexpsumï¼Œå ç”¨æ˜¾å­˜ä¸º$w\times N$</li><li>ç„¶åè¿˜è¦å­˜å‚¨ä¸€ä¸ªæœ€åçš„è¾“å‡º$O$ï¼Œå ç”¨æ˜¾å­˜ä¸º$wNd$ï¼Œä½†æ˜¯è¿™ä¸ªéƒ¨åˆ†æ˜¯å¿…é¡»çš„</li><li>å› æ­¤ï¼Œæ˜¾å­˜å ç”¨çš„å¤æ‚åº¦ä¸º$O(Nd)$ï¼ˆæˆ–è€…$O(N)$ï¼Œå¦‚æœä¸è€ƒè™‘$O$çš„è¯ï¼‰ã€‚standard attentionéœ€è¦ä¿å­˜ä¸­é—´çš„$S, P$ï¼Œæ˜¾å­˜å ç”¨å¤æ‚åº¦ä¸º$O(N^2)$</li></ul><p>faç›¸å¯¹äºstandard attentionä¸€ä¸ªä¼˜åŠ¿ï¼Œåœ¨äºå‡å°äº†è®¡ç®—è¿‡ç¨‹ä¸­çš„è®¿å­˜é‡ï¼Œæœ€åæ¥åˆ†æä¸€ä¸‹è®¿å­˜æ¬¡æ•°ï¼š</p><ul><li>standard attention<ul><li>ä»HBMä¸­è¯»å–Qï¼ŒKï¼ˆå½¢çŠ¶éƒ½æ˜¯$[N, d]$ï¼‰ï¼Œè®¿å­˜é‡=$wNd$ï¼Œè®¡ç®—$S=QK^T$ï¼Œç„¶åå‘HBMä¸­å†™å›Sï¼ˆå½¢çŠ¶ä¸º$[N, N]$ï¼‰ï¼Œè®¿å­˜é‡=$wN^2$</li><li>ä»HBMä¸­è¯»å–Sï¼Œè®¿å­˜é‡=$w N^2$ï¼Œè®¡ç®—$P=softmax(S)$ï¼Œå‘HBMä¸­å†™å›Pï¼Œè®¿å­˜é‡=$w N^2$</li><li>ä»HBMä¸­è¯»å–Pï¼ˆå½¢çŠ¶ä¸º$[N, N]$ï¼‰ã€Vï¼ˆå½¢çŠ¶ä¸º$[N, d]$ï¼‰ï¼Œè®¿å­˜é‡=$w N^2 + wNd$ï¼Œè®¡ç®—$O=PV$ï¼Œå‘HBMä¸­å†™å›Oï¼ˆå½¢çŠ¶ä¸º$[N, d]$ï¼‰ï¼Œè®¿å­˜é‡=$wNd$</li><li>æ€»çš„è®¿å­˜é‡=$w(3Nd+4N^2)$ï¼Œå¦‚æœdè¿œå°äºNï¼Œåˆ™è®¿å­˜é‡çš„å¤æ‚åº¦å˜æˆäº†$O(N^2)$</li></ul></li><li>flash attentionï¼ˆåˆ†ææ—¶å°†inner loopä½œä¸ºä¸€ä¸ªæ•´ä½“è¿›è¡Œåˆ†æï¼Œå°±åƒä¸Šé¢ç¤ºæ„å›¾ç”»çš„é‚£æ ·ï¼‰<ul><li>ä»HBMä¸­è¯»å–åˆ†å—$Q_i, i=0, &mldr;, T_r -1$ï¼Œè¯»å–åˆ†å—$K_j$ï¼Œè®¿å­˜é‡=$w(Nd+B_c d)$ï¼›åé¢$S_{ij}, \widetilde{P}_{ij}$ä¸éœ€è¦å†™å›HBMï¼›$m, l$åªæ˜¯ä¸€ä¸ªå‘é‡ï¼Œæ•°æ®é‡å¾ˆå°‘ï¼Œå¿½ç•¥ï¼›å†åé¢è¯»å–å’Œå†™å…¥åˆ†å—$O_i, i = 0, &mldr;,T_r =1$ï¼Œè®¿å­˜é‡=$w(2\times Nd)$</li><li>outer loopå…±æœ‰$\frac{N}{B_c}=T_c$æ¬¡ï¼Œæ€»çš„è®¿å­˜é‡=$w\times \frac{N}{B_c} \times (Nd + B_cd + 2Nd)=w(Nd+\frac{3N^2d}{B_c})=w(T_c+1)Nd$</li><li>æ¯”å¦‚N=1024ï¼Œd=64ï¼ŒB=64ï¼Œstandard_attentionè®¿å­˜é‡-flash_attentionè®¿å­˜é‡=$w(3Nd+4N^2-Nd-\frac{3N^2d}{B_c})=w(2Nd+(4-\frac{3d}{B_c})N^2)=w(2Nd+N^2)$ï¼Œå¯ä»¥çœ‹å‡ºå°‘äº†å¾ˆå¤šè®¿å­˜</li></ul></li></ul><h1 id=å®é™…ä½¿ç”¨>å®é™…ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#å®é™…ä½¿ç”¨>Â¶</a></h1><h2 id=æ¥å£è¿”å›å€¼>æ¥å£è¿”å›å€¼<a hidden class=anchor aria-hidden=true href=#æ¥å£è¿”å›å€¼>Â¶</a></h2><p>flash-attentionå¼€æºä»£ç ä¸­ï¼Œé’ˆå¯¹ä¸åŒqkvã€æ˜¯å¦æ˜¯varlenã€æ˜¯å¦éœ€è¦kv_cacheç­‰ä¸åŒéœ€æ±‚å°è£…äº†ä¸åŒçš„<a href=https://github.com/Dao-AILab/flash-attention/blob/main/flash_attn/flash_attn_interface.py>æ¥å£</a>ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹è¿”å›å€¼ã€‚è¿™äº›æ¥å£çš„è¿”å›å€¼éƒ½ç›¸åŒï¼Œé™¤äº†è¿”å›è¾“å‡ºçš„$O$ä¹‹å¤–ï¼Œå¦‚æœè®¾ç½®äº†<code>return_attn_probs=True</code>ï¼Œè¿˜ä¼šè¿”å›softmax_lseå’ŒS_dmaskï¼š</p><ul><li>softmax_lseï¼ˆå½¢çŠ¶$[nheads, seqlen]$ï¼‰ï¼šåœ¨è®¡ç®—$S=\frac{QK^T}{scale}$ä¹‹åï¼Œä¼šå¾—åˆ°å½¢çŠ¶ä¸º$[bs, seqlen, seqlen]$çš„æ–¹é˜µSï¼Œåœ¨è®¡ç®—softmaxçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æŒ‰è¡Œæ±‚å’Œï¼Œå¾—åˆ°ä¸€ä¸ªåˆ—å‘é‡ï¼Œç„¶åå†å–logï¼Œå†™æˆè¡¨è¾¾å¼å³ä¸ºï¼š$softmax_lse=log[\sum_je^{S_{ij}}]$ï¼Œæ³¨æ„ä¸æ˜¯$softmax_lse=log[\sum_je^{S_{ij}-rowmax(S_{ij})}]$ï¼Œå‚è€ƒissueï¼š<a href=https://github.com/Dao-AILab/flash-attention/issues/404>What&rsquo;s the exactly formula of <code>softmax_lse</code>? #404</a></li><li>S_dmaskï¼ˆå½¢çŠ¶$[bs, nheads, seqlen, seqlen]$ï¼‰ï¼šå°±æ˜¯è¿”å›$P=softmax(\frac{QK^T}{scale}+mask)$çš„è¿™ä¸ªPçŸ©é˜µ</li></ul><h2 id=varlen-attention>varlen attention<a hidden class=anchor aria-hidden=true href=#varlen-attention>Â¶</a></h2><p>ç‰¹åˆ«çš„ï¼Œè¿™é‡Œå†è¯´ä¸€ä¸‹<code>flash_attn_varlen_func</code>ç­‰ä¸€äº›æ”¯æŒvarlençš„æ¥å£ï¼Œå…¶å‡½æ•°å½¢å‚ä¸­è¿˜æœ‰<code>cu_seqlens_q</code>ã€<code>cu_seqlens_k</code>ã€<code>max_seqlen_q</code>ã€<code>max_seqlen_k</code>ç­‰ç‰¹æœ‰çš„å‚æ•°ã€‚è¿™é‡Œä»‹ç»ä¸€äº›varlenæ˜¯ä»€ä¹ˆã€‚</p><p>varlenå³å˜é•¿åºåˆ—ï¼Œäº§ç”Ÿçš„èƒŒæ™¯æ˜¯â€æ•°æ®æ‹¼æ¥â€œï¼Œå³LLMä½¿ç”¨çš„è®­ç»ƒæ•°æ®é›†ä¸­ï¼Œé•¿åº¦è¾ƒçŸ­çš„åºåˆ—å å¤§å¤šæ•°ï¼Œè¿™äº›çŸ­åºåˆ—ä¸ºäº†èƒ½å¤Ÿç¬¦åˆTransformerå›ºå®šé•¿åº¦çš„è¾“å…¥ï¼Œå°±è¦è¿›è¡Œpaddingï¼Œåºåˆ—è¶ŠçŸ­ï¼Œpaddingè¶Šå¤šï¼Œè€Œæˆ‘ä»¬ä¸å¤ªæƒ³è¦paddingï¼Œpaddingåªæ˜¯æ— å¥ˆä¹‹ä¸¾ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨varlenç‰¹æ€§ï¼Œç®€å•æ¥è¯´å°±æ˜¯å°†å¤šä¸ªçŸ­åºåˆ—æ‹¼æ¥æˆä¸€ä¸ªé•¿åºåˆ—ï¼Œä½†æ˜¯è¿˜æ˜¯æ¯ä¸ªçŸ­åºåˆ—è‡ªå·±å†…éƒ¨è®¡ç®—æ³¨æ„åŠ›ï¼ŒçŸ­åºåˆ—ä¹‹é—´æ˜¯éš”ç¦»çš„ï¼Œè¿™æ ·å‡å°‘äº†paddingï¼ŒèŠ‚çœè®¡ç®—é‡å’Œæ˜¾å­˜ã€‚</p><p>è¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼ˆ<a href=https://xtuner.readthedocs.io/zh-cn/latest/acceleration/varlen_flash_attn.html>å‚è€ƒ</a>ï¼‰ï¼Œæ¯”å¦‚ä¸€äº›çŸ­åºåˆ—é•¿åº¦åˆ†åˆ«æ˜¯ï¼š70ï¼Œ300ï¼Œ180ï¼Œ &mldr;ï¼Œ260ï¼Œ120ï¼Œ1200ï¼Œ&mldr;ç­‰ï¼Œattentionå›ºå®šè¾“å…¥é•¿åº¦æ˜¯4096ï¼Œæ­¤æ—¶æˆ‘ä»¬å°†è¿™äº›çŸ­åºåˆ—æ‹¼æ¥èµ·æ¥ï¼Œä½¿ç”¨varlen_attnåï¼Œå°±åƒå³å›¾æ‰€ç¤ºï¼Œæ¯ä¸ªçŸ­åºåˆ—è‡ªå·±å†…éƒ¨è®¡ç®—attentionï¼ŒçŸ­åºåˆ—ä¹‹é—´ä¸è®¡ç®—attentionï¼ˆå¦åˆ™å°±åƒå·¦å›¾è¿™æ ·ï¼Œç™½ç™½å¤šäº†å¾ˆå¤šæµªè´¹çš„è®¡ç®—ï¼‰</p><img src=https://cdn.jsdelivr.net/gh/QinganZhang/ImageHosting/img/2024-09-17-11:48:10.png alt=XTuner style=zoom:40%><p>ä¸ºäº†å®ç°varlenç‰¹æ€§ï¼Œéœ€è¦å¯¹æ¥å£æœ‰ä¸€äº›è°ƒæ•´ã€‚æ¯”å¦‚ä¸ä½¿ç”¨varlençš„flash_attnæ¥å£ä¸­ï¼Œä¼ å…¥çš„Qã€Kã€Vçš„å½¢çŠ¶ä¸€èˆ¬ä¸º$[bs, seqlen, nheads, head_dim]$ï¼ˆKå’ŒVçš„nheadså¯ä»¥å°‘äºQçš„nheadsï¼Œæ­¤æ—¶å°±æ˜¯GQA/MQAï¼‰ã€‚åœ¨ä½¿ç”¨varlençš„flash_attnæ¥å£ä¸­ï¼Œä¸»è¦æœ‰ä¸¤ç‚¹å˜åŒ–ï¼š</p><ul><li>Qã€Kã€Vçš„å½¢çŠ¶ä¸€èˆ¬ä¸º$[total_seq, nheads, head_dim]$ï¼Œè¿™é‡Œå°†å¤šä¸ªbatchæ‹¼æ¥èµ·æ¥ï¼Œæ‹¼èµ·æ¥çš„é•¿åº¦ä¸º$total_seq$</li><li>å¤šäº†<code>cu_seqlens_q</code>ã€<code>cu_seqlens_k</code>ã€<code>max_seqlen_q</code>ã€<code>max_seqlen_k</code>ç­‰ç‰¹æœ‰çš„å‚æ•°<ul><li><code>cu_seqlens_q</code>æ˜¯å¯¹æ¯ä¸ªçŸ­åºåˆ—çš„Qçš„é•¿åº¦çš„exclusive_scanï¼Œä½œç”¨å°±æ˜¯æ‰¾åˆ°åŸæ¥æ¯ä¸ªbatchçš„èµ·å§‹ç‚¹ï¼ˆoffsetï¼‰ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œæ­¤æ—¶<code>cu_seqlens_q=[0, 70, 370, 550, ... ]</code>ï¼Œå¦‚æœ<code>cu_seqlens_q</code>çš„å½¢çŠ¶ä¸º$[batch_size+1]$ï¼Œåˆ™éœ€è¦åœ¨æœ€åæ‹¼æ¥ä¸Šåºåˆ—Qçš„æ€»é•¿åº¦</li><li><code>max_seqlen_q</code>å¥½ç†è§£ï¼Œå°±æ˜¯çŸ­åºåˆ—çš„Qçš„æœ€é•¿é•¿åº¦</li></ul></li></ul><p>åœ¨å…·ä½“å®ç°ä¸­ï¼Œå¯¹æ¯ä¸ªåºåˆ—çš„æ¯ä¸ªheadåˆ†åˆ«launch kernelï¼Œæ¥å®ç°å¹¶è¡Œè®¡ç®—ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­è¦é€šè¿‡<code>cu_seqlens_q</code>æ¥ç¡®å®šå¯¹åº”Qçš„start_idxå’Œend_idxã€‚</p><p>å‚è€ƒï¼š</p><p><a href=https://66ring.github.io/2024/05/31/universe/ml/flash_attn_varlen_batcing_api_usage/>Flash attentionå˜é•¿batching APIä½¿ç”¨</a></p><p><a href=https://github.com/Dao-AILab/flash-attention/issues/850>How did flash-attn compute attention for cu_seqlens #850</a></p><h1 id=å‚è€ƒ>å‚è€ƒ<a hidden class=anchor aria-hidden=true href=#å‚è€ƒ>Â¶</a></h1><p><a href=https://zhuanlan.zhihu.com/p/669926191>å›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼šFlashAttention V1ï¼Œä»ç¡¬ä»¶åˆ°è®¡ç®—é€»è¾‘</a></p><p>ä¼˜è´¨å¥½æ–‡ï¼š</p><p><a href=https://zhuanlan.zhihu.com/p/668888063>[Attentionä¼˜åŒ–][2wå­—]ğŸ”¥åŸç†&å›¾è§£: ä»Online-Softmaxåˆ°FlashAttention V1/V2/V3</a></p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://qinganzhang.github.io/posts/llm%E6%97%B6%E4%BB%A3%E7%9A%84transformer%E9%87%8F%E5%8C%96%E5%88%86%E6%9E%90-%E5%8F%82%E6%95%B0%E9%87%8F%E8%AE%A1%E7%AE%97%E9%87%8F%E6%BF%80%E6%B4%BB%E5%80%BC/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></svg>&nbsp;Prev Page</span><br><span>LLMæ—¶ä»£çš„transformerå‚æ•°é‡ã€è®¡ç®—é‡ã€æ¿€æ´»å€¼çš„åˆ†æ</span>
</a><a class=next href=https://qinganzhang.github.io/posts/%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD%E5%92%8C%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86%E7%AE%80%E6%9E%90/><span class=title>Next Page&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span><br><span>åå‘ä¼ æ’­å’Œè‡ªåŠ¨å¾®åˆ†ç®€æ</span></a></nav></footer><div class=comments-separator></div></article></main><footer class=footer><span>&copy; 2024 <a href=https://qinganzhang.github.io/>Paul's Blog</a></span><span style=display:inline-block;margin-left:1em>
<a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a>
</span><span style=display:inline-block;margin-left:1em>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
    <a href=https://github.com/reorx/hugo-PaperModX/ rel=noopener target=_blank>PaperModX</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(){const t=""=="1";if(t)return;let e=document.getElementById("theme-toggle");e.removeEventListener("click",toggleThemeListener),e.addEventListener("click",toggleThemeListener)})()</script><script>(function(){let e=document.getElementById("menu");e&&(e.scrollLeft=localStorage.getItem("menu-scroll-position"),e.onscroll=function(){localStorage.setItem("menu-scroll-position",e.scrollLeft)});const t=""=="1",n=""=="1";if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||t||n)return;document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})})()</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>if(window.scrollListeners)for(const e of scrollListeners)window.removeEventListener("scroll",e);window.scrollListeners=[]</script><script src=/js/medium-zoom.min.js data-no-instant></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>(function(){const a="1"=="1";if(!a)return;if(!document.querySelector(".toc")){console.log("no toc found, ignore toc scroll");return}const r=window.scrollListeners,t=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id]"),n="active";let e=t[0];o(e).classList.add(n);const c=()=>{const s=[];for(const e of t)if(l(e)<5)s.push(e);else break;s.length>0?newActiveHeading=s[s.length-1]:newActiveHeading=t[0],e!=newActiveHeading&&(o(e).classList.remove(n),e=newActiveHeading,o(e).classList.add(n))};let s=null;const i=()=>{s!==null&&clearTimeout(s),s=setTimeout(c,50)};window.addEventListener("scroll",i,!1),r.push(i);function o(e){const t=encodeURI(e.getAttribute("id")).toLowerCase();return document.querySelector(`.toc ul li a[href="#${t}"]`)}function l(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect();return t.top}})()</script></body></html>